<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiFi Network Scanner</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; overflow: hidden; }
        .header { position: fixed; top: 0; left: 0; right: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); padding: 15px 20px; z-index: 1000; display: flex; justify-content: space-between; align-items: center; }
        .title { font-size: 24px; font-weight: bold; }
        .controls { display: flex; gap: 15px; align-items: center; }
        select, button { padding: 8px 12px; border: none; border-radius: 5px; background: rgba(255, 255, 255, 0.1); color: white; cursor: pointer; transition: all 0.3s ease; }
        select:hover, button:hover { background: rgba(255, 255, 255, 0.2); }
        button { background: #4CAF50; }
        button:hover { background: #45a049; }
        button.stop { background: #f44336; }
        button.stop:hover { background: #da190b; }
        .status { font-size: 14px; opacity: 0.8; }
        .stats { position: fixed; top: 80px; right: 20px; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); padding: 15px; border-radius: 10px; z-index: 999; min-width: 200px; }
        .stats h3 { margin-bottom: 10px; font-size: 16px; }
        .stat-item { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; }
        .network-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
        .node { cursor: pointer; }
        .node.ap circle { fill: #ff6b6b; stroke: #ff5252; }
        .node.client circle { fill: #4ecdc4; stroke: #26a69a; }
        .node text {
            pointer-events: none;
            font-family: sans-serif;
            fill: white;
            paint-order: stroke;
            stroke: #222;
            stroke-width: 2px;
            stroke-linecap: butt;
            stroke-linejoin: miter;
        }
        .link { stroke: #ffffff; stroke-opacity: 0.6; stroke-linecap: round; }
        .legend { position: fixed; bottom: 20px; left: 20px; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); padding: 15px; border-radius: 10px; z-index: 999; }
        .legend h3 { margin-bottom: 10px; font-size: 16px; }
        .legend-item { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 14px; }
        .legend-color { width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">WiFi Network Scanner</div>
        <div class="controls">
            <select id="interfaceSelect"><option value="">Select Interface</option></select>
            <button id="startBtn">Start Scan</button>
            <button id="stopBtn" class="stop" style="display: none;">Stop Scan</button>
        </div>
        <div class="status" id="status">Ready</div>
    </div>
    <div class="stats">
        <h3>Network Statistics</h3>
        <div class="stat-item"><span>Access Points:</span><span id="apCount">0</span></div>
        <div class="stat-item"><span>Clients:</span><span id="clientCount">0</span></div>
        <div class="stat-item"><span>Connections:</span><span id="connectionCount">0</span></div>
        <div class="stat-item"><span>Total Packets:</span><span id="packetCount">0</span></div>
    </div>
    <div class="legend">
        <h3>Legend</h3>
        <div class="legend-item"><div class="legend-color" style="background: #ff6b6b;"></div><span>Access Points</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #4ecdc4;"></div><span>Clients</span></div>
    </div>
    <svg class="network-canvas" id="networkCanvas"></svg>

    <script>
        let socket;
        let simulation;
        let nodes = [];
        let links = [];
        const width = window.innerWidth;
        const height = window.innerHeight;
        
        const svg = d3.select('#networkCanvas').attr('width', width).attr('height', height);
        const g = svg.append('g');
        let link = g.append("g").attr("stroke-opacity", 0.6).selectAll("line");
        let node = g.append("g").selectAll("g");
        
        const zoom = d3.zoom().scaleExtent([0.1, 8]).on('zoom', (event) => {
            g.attr('transform', event.transform);
            // Adjust label font size to counteract the zoom effect
            const k = event.transform.k;
            g.selectAll('.node text').attr('font-size', 12 / k);
            g.selectAll('.node circle').attr('stroke-width', 1.5 / k);
        });

        svg.call(zoom);

        function ticked() {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);
            node.attr("transform", d => `translate(${d.x},${d.y})`);
        }
        
        simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(d => d.id).distance(120))
            .force("charge", d3.forceManyBody().strength(-500))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .on("tick", ticked);

        function updateNetwork(data) {
            document.getElementById('apCount').textContent = data.access_points.length;
            document.getElementById('clientCount').textContent = data.clients.length;
            document.getElementById('connectionCount').textContent = data.connections.length;
            document.getElementById('packetCount').textContent = data.connections.reduce((sum, conn) => sum + conn.packet_count, 0);

            const oldNodes = new Map(node.data().map(d => [d.id, d]));
            nodes = data.access_points.map(ap => ({...ap, id: ap.bssid, type: 'ap', label: ap.ssid || 'Unknown'}))
                  .concat(data.clients.map(c => ({...c, id: c.mac, type: 'client', label: `Client ${c.mac.slice(-6)}`})));
            nodes = nodes.map(d => Object.assign(oldNodes.get(d.id) || {}, d));
            
            links = data.connections.map(d => ({...d, source: d.ap_bssid, target: d.client_mac}));

            node = node.data(nodes, d => d.id).join(
                enter => {
                    const g = enter.append("g").attr("class", d => `node ${d.type}`).call(drag(simulation));
                    g.append("circle").attr("r", d => d.type === 'ap' ? 15 : 10);
                    g.append("text")
                     .attr("y", -20)
                     .attr("text-anchor", "middle")
                     .attr("font-size", "12") // Initial font size
                     .text(d => d.label.substring(0, 16));
                    return g;
                }
            );
            
            link = link.data(links, d => `${d.source.id}-${d.target.id}`).join("line")
                .attr("class", "link")
                .attr("stroke-width", d => Math.min(10, Math.max(1, d.thickness / 2)));

            simulation.nodes(nodes);
            simulation.force("link").links(links);
            simulation.alpha(1).restart();
        }
        
        function drag(simulation) {
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x; d.fy = d.y;
            }
            function dragged(event, d) {
                d.fx = event.x; d.fy = event.y;
            }
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null; d.fy = null;
            }
            return d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended);
        }

        async function loadInterfaces() {
            try {
                const response = await fetch('/api/interfaces');
                const data = await response.json();
                const select = document.getElementById('interfaceSelect');
                select.innerHTML = '<option value="">Select Interface</option>';
                data.interfaces.forEach(iface => {
                    const option = document.createElement('option');
                    option.value = iface; option.textContent = iface;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading interfaces:', error);
            }
        }
        
        async function startScan() {
            const selectedInterface = document.getElementById('interfaceSelect').value;
            if (!selectedInterface) return alert('Please select a WiFi interface');
            
            await fetch('/api/start_scan', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ interface: selectedInterface })
            });
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'block';
        }
        
        async function stopScan() {
            await fetch('/api/stop_scan', { method: 'POST' });
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';
            updateNetwork({access_points:[], clients:[], connections:[]});
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadInterfaces();
            socket = io();
            socket.on('network_update', updateNetwork);
            socket.on('status', data => document.getElementById('status').textContent = data.message);
            document.getElementById('startBtn').addEventListener('click', startScan);
            document.getElementById('stopBtn').addEventListener('click', stopScan);
        });
    </script>
</body>
</html>